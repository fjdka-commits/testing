<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì˜¤ë Œì§€ ì£¼ì‹íšŒì‚¬ ì„ì§ì› ì‡¼í•‘ëª°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* í°íŠ¸ ë° ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì„¤ì • */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        
        body {
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
            background-color: #f7f7f7; /* ë°°ê²½ìƒ‰ì„ ë°ì€ íšŒìƒ‰ìœ¼ë¡œ ë³€ê²½ */
            color: #333;
        }

        /* ìƒí’ˆ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .product-card {
            cursor: pointer;
            /* scale íŠ¸ëœì§€ì…˜ ì¶”ê°€ */
            transition: transform 0.2s, box-shadow 0.2s, scale 0.2s; 
            background-color: #fff;
            border: 1px solid #eee; 
            box-shadow: none !important; 
            overflow: hidden;
            text-align: left;
        }
        .product-card:hover {
            transform: translateY(-3px);
            scale: 1.03; /* ë§ˆìš°ìŠ¤ ì˜¤ë²„ ì‹œ ì‚´ì§ í™•ëŒ€ */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        .product-image-container {
            background-color: #f5f5f5; 
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .product-image {
            width: 100%;
            height: 250px;
            object-fit: contain; 
        }
        
        /* ìƒí’ˆ ì •ë³´ ì˜ì—­ ìŠ¤íƒ€ì¼ (ë†’ì´ í™•ì¥ ê¸°ëŠ¥ ì œê±°) */
        .product-info {
            padding: 1rem;
            position: relative;
            /* ë†’ì´ ì œì–´ ê´€ë ¨ ì†ì„± ì œê±° */
            overflow: hidden; 
        }

        /* ìƒí’ˆ ì„¤ëª… í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ (ì¤„ ìˆ˜ ì œí•œ ì œê±° ë° ì˜¤ë²„í”Œë¡œìš° ê´€ë¦¬) */
        .product-description {
            font-size: 0.875rem; 
            color: #9ca3af; 
            margin-top: 0.5rem; 
            
            /* í…ìŠ¤íŠ¸ê°€ ì˜ë¦¬ì§€ ì•Šë„ë¡ ì¤„ ìˆ˜ ì œí•œ ì œê±° */
            display: block; 
            overflow: visible; 
            word-break: break-word; 
            height: auto; 
        }
        
        /* ì´ë¦„ê³¼ ê°€ê²©ì€ í•­ìƒ ì˜¨ì „íˆ ë³´ì´ë„ë¡ ì„¤ì • */
        .product-name, .product-price {
            display: block !important; 
            overflow: visible !important;
            word-break: break-word;
        }


        /* íŒì—… ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal {
            display: none; 
            position: fixed;
            z-index: 50; 
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7); 
        }

        .modal-content {
            background-color: #fff;
            margin: 15vh auto; 
            padding: 30px;
            border-radius: 8px;
            max-width: 400px; 
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2);
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close-btn:hover,
        .close-btn:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        #checkout-btn {
            background-color: #1a1a1a; 
            transition: background-color 0.2s;
        }
        #checkout-btn:hover:not(:disabled) {
            background-color: #555;
        }
        #checkout-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
    </style>
</head>
<body>

    <!-- í—¤ë” - ê¹”ë”í•˜ê³  ë¯¸ë‹ˆë©€í•œ ë””ìì¸ --><header class="bg-white border-b border-gray-200">
        <div class="max-w-7xl mx-auto flex justify-between items-center py-4 px-4 sm:px-6 lg:px-8">
            <h1 class="text-xl font-semibold tracking-widest text-gray-900 uppercase">
                 Orange Company
            </h1>
            <nav class="hidden sm:block">
                <a href="#" class="text-sm text-gray-500 hover:text-gray-900 mx-3">HOME</a>
                <a href="#" class="text-sm text-gray-900 font-medium mx-3">SHOP</a>
                <a href="#" class="text-sm text-gray-500 hover:text-gray-900 mx-3">CONTACT</a>
            </nav>
            <div class="flex items-center">
                <!-- ì¥ë°”êµ¬ë‹ˆ ì•„ì´ì½˜ ë° ì¹´ìš´íŠ¸ --><div class="relative cursor-pointer hover:text-gray-900 text-gray-500" onclick="openCartModal()">
                    <!-- Shopping Bag Icon (Lucide) --><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6">
                        <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"></path>
                        <path d="M3 6h18"></path>
                        <path d="M16 10a4 4 0 0 1-8 0"></path>
                    </svg>
                    <!-- Cart Count Indicator --><span id="cart-count" class="absolute -top-1 -right-1 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-red-100 transform translate-x-1/2 -translate-y-1/2 bg-red-600 rounded-full">
                        0
                    </span>
                </div>
            </div>
        </div>
    </header>

    <!-- ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ --><main class="max-w-7xl mx-auto mt-10 px-4 sm:px-6 lg:px-8">
        <!-- ìƒí’ˆ ë¶„ë¥˜ í—¤ë” --><div class="mb-8 pb-4 border-b border-gray-300">
            <h2 class="text-4xl font-light tracking-wide mb-2">SHOP LIST</h2>
            <p class="text-sm text-gray-500">prepared just for you, ONE DAY ONE ORANGE</p>
        </div>

        <!-- ìƒí’ˆ ëª©ë¡ --><div id="product-list" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
            <!-- ìƒí’ˆ ì¹´ë“œë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤. --></div>
    </main>

    <!-- ì¥ë°”êµ¬ë‹ˆ/ì²´í¬ì•„ì›ƒ íŒì—… ì°½ (ëª¨ë‹¬) --><div id="cart-checkout-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="cart-modal-title">
        <div class="modal-content !max-w-lg">
            <span class="close-btn" onclick="closeCartModal()">&times;</span>
            <h2 id="cart-modal-title" class="text-2xl font-medium mb-6 text-gray-900 text-center">SHOPPING CART</h2>
            
            <div id="cart-items-container" class="max-h-60 overflow-y-auto pr-2">
                <!-- Cart items rendered here --><p id="empty-cart-message" class="text-center text-gray-500 py-8 hidden">ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</p>
            </div>

            <div class="mt-6 pt-4 border-t border-gray-200">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-lg font-medium text-gray-900">ì´ ê²°ì œ ê¸ˆì•¡:</span>
                    <span id="cart-total-value" class="text-xl font-bold text-gray-900">0 P</span>
                </div>

                <div class="mb-6 text-left">
                    <!-- 2. êµ¬ë§¤ì ì´ë¦„ ëŒ€ì‹  4ìë¦¬ ì§ì› ì½”ë“œë¡œ ë³€ê²½ --><label for="checkout-employee-code" class="block text-sm font-medium text-gray-700 mb-2">
                        ì§ì› ì½”ë“œ (4ìë¦¬ ìˆ«ì, ì˜êµ¬ ì €ì¥):
                    </label>
                    <input type="tel" id="checkout-employee-code" placeholder="4ìë¦¬ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 1004)" 
                        class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-sm focus:ring-gray-700 focus:border-gray-700 sm:text-sm"
                        maxlength="4" inputmode="numeric" pattern="[0-9]{4}">
                </div>

                <button id="checkout-btn" 
                        class="w-full py-3 px-4 rounded-sm text-white font-medium shadow-sm bg-gray-900 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-black" disabled>
                    ì¥ë°”êµ¬ë‹ˆ ì „ì²´ êµ¬ë§¤ í™•ì •
                </button>

                <!-- ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ ì˜ì—­ --><p id="checkout-error-message" class="text-red-500 text-sm mt-3 hidden text-center">ì§ì› ì½”ë“œ(4ìë¦¬ ìˆ«ì)ë¥¼ ì…ë ¥í•´ì•¼ êµ¬ë§¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            </div>
        </div>
    </div>

    <!-- Firebase SDK Import (type="module" í•„ìˆ˜) --><script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            addDoc, 
            collection
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase ì„¤ì •: í™˜ê²½ ë³€ìˆ˜ì—ì„œ ê°’ ê°€ì ¸ì˜¤ê¸° (í•„ìˆ˜)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // ì „ì—­ ë³€ìˆ˜ ì„¤ì •
        let db = null;
        let auth = null;
        let userId = null;
        let isFirebaseReady = false; 

        if (firebaseConfig) {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // ì¸ì¦ ë° userId ì„¤ì •
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                } else {
                    try {
                        if (initialAuthToken) {
                            const userCredential = await signInWithCustomToken(auth, initialAuthToken);
                            userId = userCredential.user.uid;
                        } else {
                            const userCredential = await signInAnonymously(auth);
                            userId = userCredential.user.uid;
                        }
                    } catch (error) {
                        console.error("Firebase Auth failed:", error);
                        userId = crypto.randomUUID(); // ì¸ì¦ ì‹¤íŒ¨ ì‹œ ëŒ€ì²´ ID
                    }
                }
                isFirebaseReady = true;
                console.log("Firebase Ready. User ID:", userId);
            });
        } else {
            console.error("Firebase configuration is missing.");
        }
        
        // ë©”ì¸ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì‚¬ìš©í•˜ë„ë¡ í•¨ìˆ˜ ë° ë³€ìˆ˜ ë…¸ì¶œ
        window.db = db;
        window.addDoc = addDoc;
        window.collection = collection;
        window.getFirebaseReady = () => isFirebaseReady;
        window.getUserId = () => userId;
        window.getAppId = () => appId;
    </script>

    <!-- ë©”ì¸ ìŠ¤í¬ë¦½íŠ¸ --><script>
        // "alert()" ëŒ€ì‹  ì‚¬ìš©í•  ê°„ë‹¨í•œ ëª¨ë‹¬ ë©”ì‹œì§€ í•¨ìˆ˜
        function showMessage(message) {
            const messageBox = document.createElement('div');
            messageBox.className = 'fixed top-4 right-4 bg-gray-900 text-white p-4 rounded-md shadow-xl z-50 transition duration-300 ease-in-out';
            messageBox.textContent = message;
            document.body.appendChild(messageBox);
            setTimeout(() => {
                messageBox.remove();
            }, 3000);
        }

        // íŠ¹ì • ëª¨ë‹¬ì˜ ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ í‘œì‹œí•˜ëŠ” ë²”ìš© í•¨ìˆ˜
        function showErrorMessage(message, elementId) {
            const errorElement = document.getElementById(elementId);
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.classList.remove('hidden');
            }
        }

        // íŠ¹ì • ëª¨ë‹¬ì˜ ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ ìˆ¨ê¸°ëŠ” ë²”ìš© í•¨ìˆ˜
        function hideErrorMessage(elementId) {
            const errorElement = document.getElementById(elementId);
            if (errorElement) {
                errorElement.classList.add('hidden');
            }
        }
        
        // Helper: Firebaseê°€ ì™„ì „íˆ ì´ˆê¸°í™”ë˜ê³  ì¸ì¦ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦½ë‹ˆë‹¤.
        async function waitForFirebaseReady(timeout = 5000) {
            const startTime = Date.now();
            return new Promise((resolve, reject) => {
                const check = () => {
                    // window.getFirebaseReady()ì™€ window.dbê°€ ëª¨ë‘ true/ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
                    if (window.getFirebaseReady() && window.db) {
                        resolve();
                    } else if (Date.now() - startTime > timeout) {
                        reject(new Error("Firebase initialization timed out."));
                    } else {
                        setTimeout(check, 100); // 100ms í›„ ë‹¤ì‹œ í™•ì¸
                    }
                };
                check();
            });
        }


        // 1. ìƒí’ˆ ë°ì´í„° ì •ì˜ (ë‚´ìš© ìœ ì§€)
        const products = [
            { 
                id: 1, 
                name: "í”„ë¦¬ë¯¸ì—„ ì˜¤ë Œì§€ì£¼ìŠ¤", 
                description: "ë¬´ë ¤ ì§„ì§œ ì˜¤ë Œì§€ì¦™ì´ 1%ë‚˜ í•¨ìœ ëœ í”„ë¦¬ë¯¸ì—„ ì˜¤ë Œì§€ ì£¼ìŠ¤ë‹¤. ì›°ëª¬íŠ¸ì˜ íš¨ì ìƒí’ˆ. ì˜¤ì—¼ë„ -20%", 
                price: "500 P", 
                image: "https://cdn.discordapp.com/attachments/1428005198143688714/1438515462383075478/d842b46950944d07.png?ex=6917296c&is=6915d7ec&hm=bec868bc297693e6c669148b0455921e45448abab7b48ba6e87216861e3dcc74" 
            },
            { 
                id: 2, 
                name: "ì˜¤ë Œì§€ì£¼ìŠ¤", 
                description: "ì–´ë””ì„œë‚˜ ë³¼ ìˆ˜ ìˆëŠ” í”í•œ ì˜¤ë Œì§€ ì£¼ìŠ¤. ì„¤íƒ• í•¨ìœ ëŸ‰ì´ ë†’ë‹¤. ì˜¤ì—¼ë„ -10%", 
                price: "200 P", 
                image: "https://cdn.discordapp.com/attachments/1394056401088679966/1438570414912569576/KakaoTalk_20251110_094656257.png?ex=69175c9a&is=69160b1a&hm=632767b34082852c5c64f6e222cde210b79da22aeae91d857c23ef55c4d98227" 
            },
            { 
                id: 3, 
                name: "í•„ë¦„ ì¹´ë©”ë¼", 
                description: "ë”± í•œ ì¥ í•„ë¦„ì´ ë‚¨ì•„ìˆëŠ” ë‚¡ì€ ì¹´ë©”ë¼ë‹¤. ì›í•˜ëŠ” ì‚¬ëŒë“¤ì„ ì°ê±°ë‚˜ í•¨ê»˜ ì‚¬ì§„ì„ í•œ ì¥ ë‚¨ê¸¸ ìˆ˜ ìˆë‹¤. (ì¸í™”ëŠ” íŒ€ì¥ì—ê²Œ ë¬¸ì˜í•˜ë„ë¡!)", 
                price: "3000 P", 
                image: "https://cdn.discordapp.com/attachments/1394056401088679966/1438571013905449030/KakaoTalk_20251110_094656257_01.png?ex=69175d29&is=69160ba9&hm=0ef2d5ba3515fd469632543a6e458414b238fd00e63e755697980e1562016a80" 
            },
            { 
                id: 4, 
                name: "Oì˜ ëœë¤ë°•ìŠ¤", 
                description: "ìš°ë¦¬ì˜ ë§ˆìŠ¤ì½”íŠ¸ ë¡œë´‡ Oê°€ ëŒë ¤ì£¼ëŠ” 1,000p ëœë¤ ë°•ìŠ¤. ìƒì  ì•„ì´í…œ ì¤‘ ëœë¤í•œ ë¬¼ê±´ì„ ì¦ì •! * íˆë“  ì•„ì´í…œ ì¡´ì¬ *", 
                price: "1000 P", 
                image: "https://cdn.discordapp.com/attachments/1394056401088679966/1438571437332893827/6935302d628b746b.png?ex=69175d8e&is=69160c0e&hm=f06d8eafe27214997322d4fe874ff346c3f9240ba35cd36af522a315df6f049b" 
            },
            { 
                id: 5, 
                name: "ë¯¸ì •", 
                description: "ë¯¸ì • ìƒí’ˆì…ë‹ˆë‹¤.", 
                price: "0 P", 
                image: "https://images.unsplash.com/photo-1603597818464-96657958b4b2?w=400&h=400&fit=crop" 
            }
        ];

        // --- ì „ì—­ ìƒíƒœ ë° DOM ìš”ì†Œ ì°¸ì¡° ---
        let cart = []; // ì¥ë°”êµ¬ë‹ˆ ìƒíƒœ (ìƒí’ˆ ê°ì²´ + quantity)

        const productList = document.getElementById('product-list');
        
        // ì¥ë°”êµ¬ë‹ˆ ì²´í¬ì•„ì›ƒ ëª¨ë‹¬ (#cart-checkout-modal)
        const cartModal = document.getElementById('cart-checkout-modal');
        const cartItemsContainer = document.getElementById('cart-items-container');
        const cartTotalValue = document.getElementById('cart-total-value');
        const cartCountIndicator = document.getElementById('cart-count');
        
        // ì§ì› ì½”ë“œë¡œ ë³€ê²½ëœ ì…ë ¥ í•„ë“œ ì°¸ì¡°
        const checkoutEmployeeCodeInput = document.getElementById('checkout-employee-code');
        const checkoutBtn = document.getElementById('checkout-btn');
        const checkoutErrorMessageId = 'checkout-error-message';
        const emptyCartMessage = document.getElementById('empty-cart-message');

        // Helper: P(í¬ì¸íŠ¸) ë¬¸ìì—´ì„ ìˆ«ìë¡œ ë³€í™˜
        function parsePrice(priceString) {
            return parseInt(priceString.replace(' P', '').replace(/,/g, ''), 10);
        }
        
        // Helper: ì¹´íŠ¸ ì•„ì´í…œ ìˆ˜ ì—…ë°ì´íŠ¸
        function updateCartCount() {
            // ì¥ë°”êµ¬ë‹ˆì— ë‹´ê¸´ í’ˆëª©ì˜ 'ì¢…ë¥˜' ìˆ˜ë¥¼ í‘œì‹œ
            cartCountIndicator.textContent = cart.length;
        }

        // ìƒí’ˆ ëª©ë¡ ë™ì  ìƒì„± í•¨ìˆ˜
        function renderProducts() {
            productList.innerHTML = ''; 
            products.forEach(product => {
                const card = document.createElement('div');
                card.classList.add('product-card', 'rounded-lg'); 
                card.setAttribute('data-product-id', product.id);

                card.innerHTML = `
                    <div class="product-image-container rounded-t-lg">
                        <img src="${product.image}" alt="${product.name}" class="product-image">
                    </div>
                    <div class="product-info">
                        <p class="product-name text-lg font-medium text-gray-900 mb-1">${product.name}</p> 
                        <p class="product-price text-base font-semibold text-gray-900 mb-1">${product.price}</p> 
                        <p class="product-description text-sm text-gray-400 mt-2">${product.description}</p> 
                    </div>
                `;
                
                card.addEventListener('click', () => {
                    addToCart(product);
                });

                productList.appendChild(card);
            });
        }
        
        // ì¥ë°”êµ¬ë‹ˆì— ë‹´ê¸° (ë°”ë¡œ ë‹´ê¸° ê¸°ëŠ¥)
        function addToCart(product) {
            const existingItem = cart.find(item => item.id === product.id);
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push({ ...product, quantity: 1 });
            }
            updateCartCount();
            showMessage(`âœ… ${product.name}ì´(ê°€) ì¥ë°”êµ¬ë‹ˆì— ë‹´ê²¼ìŠµë‹ˆë‹¤. (ìˆ˜ëŸ‰: ${existingItem ? existingItem.quantity : 1})`);
        }
        
        // ì¥ë°”êµ¬ë‹ˆ ì´ ê¸ˆì•¡ ê³„ì‚°
        function calculateCartTotal() {
            return cart.reduce((total, item) => {
                return total + (parsePrice(item.price) * item.quantity);
            }, 0);
        }

        // ì¥ë°”êµ¬ë‹ˆ ì•„ì´í…œ ë Œë”ë§
        function renderCartItems() {
            cartItemsContainer.innerHTML = '';
            if (cart.length === 0) {
                emptyCartMessage.classList.remove('hidden');
                cartTotalValue.textContent = '0 P';
                checkoutBtn.disabled = true;
                return;
            }
            emptyCartMessage.classList.add('hidden');
            checkoutBtn.disabled = false;
            
            cart.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex items-center justify-between p-3 border-b border-gray-100 last:border-b-0';
                
                const totalItemPrice = parsePrice(item.price) * item.quantity;

                itemDiv.innerHTML = `
                    <div class="flex items-center flex-1">
                        <img src="${item.image}" alt="${item.name}" class="w-10 h-10 object-contain mr-4 bg-gray-50 rounded-sm">
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-900 truncate">${item.name}</p>
                            <p class="text-xs text-gray-500">${item.price} x ${item.quantity} = ${totalItemPrice.toLocaleString('ko-KR')} P</p>
                        </div>
                    </div>
                    <button class="text-red-500 hover:text-red-700 text-sm py-1 px-2 rounded hover:bg-red-50" onclick="removeItemFromCart(${index})">
                        ì‚­ì œ
                    </button>
                `;
                cartItemsContainer.appendChild(itemDiv);
            });
            
            // ì´í•© ì—…ë°ì´íŠ¸
            cartTotalValue.textContent = `${calculateCartTotal().toLocaleString('ko-KR')} P`;
        }
        
        // ì¥ë°”êµ¬ë‹ˆ ì•„ì´í…œ ì‚­ì œ
        window.removeItemFromCart = (index) => {
            cart.splice(index, 1);
            renderCartItems();
            updateCartCount();
            showMessage('Item removed from cart.');
        }

        // ì¥ë°”êµ¬ë‹ˆ íŒì—… ì—´ê¸°/ë‹«ê¸°
        window.openCartModal = () => {
            renderCartItems();
            checkoutEmployeeCodeInput.value = '';
            hideErrorMessage(checkoutErrorMessageId);
            cartModal.style.display = 'block';
            if (cart.length > 0) {
                 checkoutEmployeeCodeInput.focus();
            }
        }

        window.closeCartModal = () => {
            cartModal.style.display = 'none';
        }

        // íŒì—… ì™¸ë¶€ í´ë¦­ ë° ë‹«ê¸° ë²„íŠ¼ ì„¤ì •
        window.onclick = (event) => {
            if (event.target == cartModal) {
                closeCartModal();
            }
        };

        // ì¥ë°”êµ¬ë‹ˆ ì „ì²´ êµ¬ë§¤ í™•ì • (ì²´í¬ì•„ì›ƒ) ì´ë²¤íŠ¸
        checkoutBtn.addEventListener('click', async () => {
            const employeeCode = checkoutEmployeeCodeInput.value.trim();

            if (cart.length === 0) {
                 showErrorMessage('ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.', checkoutErrorMessageId);
                 return;
            }

            // ì§ì› ì½”ë“œ ìœ íš¨ì„± ê²€ì‚¬ (4ìë¦¬ ìˆ«ì)
            const codeRegex = /^\d{4}$/;
            if (!codeRegex.test(employeeCode)) {
                showErrorMessage('ì§ì› ì½”ë“œ(4ìë¦¬ ìˆ«ì)ë¥¼ ì •í™•íˆ ì…ë ¥í•´ì•¼ êµ¬ë§¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', checkoutErrorMessageId);
                return;
            }

            hideErrorMessage(checkoutErrorMessageId);
            await checkoutFromCart(employeeCode); // ì§ì› ì½”ë“œë¥¼ ì¸ìˆ˜ë¡œ ì „ë‹¬
        });

        // ì—”í„° í‚¤ ì´ë²¤íŠ¸ (ì¥ë°”êµ¬ë‹ˆ êµ¬ë§¤)
        checkoutEmployeeCodeInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault(); 
                checkoutBtn.click();
            }
        });

        // Firebase êµ¬ë§¤ ì €ì¥ ë¡œì§
        async function savePurchase(product, employeeCode, transactionType) {
            // NOTE: ì´ í•¨ìˆ˜ëŠ” ìƒìœ„ í•¨ìˆ˜(checkoutFromCart)ì—ì„œ Firebase ì¤€ë¹„ê°€ ì™„ë£Œë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦° í›„ í˜¸ì¶œëœë‹¤ê³  ê°€ì •
            if (!window.db) {
                 throw new Error('Database connection is not available.');
            }

            const purchaseInfo = {
                // êµ¬ë§¤ì ì´ë¦„ ëŒ€ì‹  ì§ì› ì½”ë“œë¥¼ ì €ì¥
                employeeCode: employeeCode,
                item: product.name,
                price: product.price,
                quantity: product.quantity || 1,
                transactionType: transactionType, // 'cart'
                date: new Date().toLocaleString('ko-KR', { hour12: false }),
                totalPrice: (parsePrice(product.price) * (product.quantity || 1)),
                userId: window.getUserId(), 
                appId: window.getAppId()
            };

            const path = `artifacts/${window.getAppId()}/public/data/purchases`;
            const docRef = await window.addDoc(window.collection(window.db, path), purchaseInfo);
            
            // ì½˜ì†” ë¡œê·¸ì— ì§ì› ì½”ë“œì™€ í’ˆëª©ì„ ëª…í™•íˆ í‘œì‹œ
            console.log(`
âœ… êµ¬ë§¤ ì™„ë£Œ! (ì¥ë°”êµ¬ë‹ˆ êµ¬ë§¤) - Firestore Doc ID: ${docRef.id}
--------------------------------------------------
ì§ì› ì½”ë“œ: ${employeeCode}
êµ¬ë§¤ í’ˆëª©: ${product.name}
ìˆ˜ëŸ‰: ${purchaseInfo.quantity}
ì´ ê¸ˆì•¡: ${purchaseInfo.totalPrice.toLocaleString('ko-KR')} P
--------------------------------------------------
`);
            return docRef.id;
        }
        
        // ì¥ë°”êµ¬ë‹ˆ ì „ì²´ êµ¬ë§¤ í•¨ìˆ˜
        async function checkoutFromCart(employeeCode) {
            checkoutBtn.disabled = true;
            
            try {
                // ğŸš¨ CRITICAL FIX: Firebase ì´ˆê¸°í™”ê°€ ì™„ë£Œë  ë•Œê¹Œì§€ ëŒ€ê¸°
                await waitForFirebaseReady(); 
                
                // ì¥ë°”êµ¬ë‹ˆì— ìˆëŠ” ëª¨ë“  ì•„ì´í…œì— ëŒ€í•´ ê°œë³„ êµ¬ë§¤ ê¸°ë¡ì„ ì €ì¥ (Promise.allë¡œ ë³‘ë ¬ ì²˜ë¦¬)
                const savePromises = cart.map(item => savePurchase(item, employeeCode, 'cart'));
                await Promise.all(savePromises);
                
                // êµ¬ë§¤ ì„±ê³µ í›„ ì¥ë°”êµ¬ë‹ˆ ì´ˆê¸°í™”
                const totalItems = cart.length;
                cart = [];
                updateCartCount();
                renderCartItems();
                
                showMessage(`êµ¬ë§¤ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! (ì§ì› ì½”ë“œ: ${employeeCode}, ì´ ${totalItems}ê°œ)`);
                closeCartModal();

            } catch (error) {
                console.error("Cart checkout failed:", error);
                 if (error.message.includes("timed out")) {
                    showErrorMessage('ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.', checkoutErrorMessageId);
                } else {
                    showErrorMessage('ì „ì²´ êµ¬ë§¤ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.', checkoutErrorMessageId);
                }
            } finally {
                checkoutBtn.disabled = false;
            }
        }


        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìƒí’ˆ ëª©ë¡ ìƒì„±
        window.onload = () => {
            renderProducts();
            updateCartCount(); // ì´ˆê¸° ì¹´ìš´íŠ¸ ì„¤ì •
        };
    </script>
</body>
</html>